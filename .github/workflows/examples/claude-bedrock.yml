# Example workflow for Claude Code with Amazon Bedrock
#
# This workflow demonstrates how to use the Application Observability for AWS action
# with Claude Code and a custom Bedrock model.
#
# Key Features:
# - Brings your own Bedrock model (pay-per-token usage on your AWS account)
# - Uses Anthropic's official claude-code-base-action for execution
# - Two-step process: preparation + execution
#
# Prerequisites:
# 1. AWS IAM role with OIDC trust for GitHub Actions
# 2. Bedrock InvokeModel permissions in your IAM role
# 3. Application Signals and CloudWatch permissions
#
# Setup:
# 1. Create repository secret AWSAPM_ROLE_ARN with your IAM role ARN
# 2. (Optional) Set repository variable AWS_REGION for your preferred region
# 3. Copy this file to .github/workflows/awsapm.yml in your repository

name: Application observability for AWS (Claude + Bedrock)

on:
  issue_comment:
    types: [created, edited]
  issues:
    types: [opened, assigned, edited]

jobs:
  awsapm-investigation:
    # Only run when @awsapm is mentioned
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@awsapm')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@awsapm') || contains(github.event.issue.title, '@awsapm')))
    runs-on: ubuntu-latest

    permissions:
      contents: write        # To create branches for PRs
      pull-requests: write   # To post comments on PRs
      issues: write          # To post comments on issues
      id-token: write        # Required for AWS OIDC authentication

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWSAPM_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      # Step 1: Prepare AWS MCP configuration and investigation prompt
      - name: Prepare Investigation Context
        id: prepare
        uses: aws-actions/application-observability-for-aws@v2
        with:
          bot_name: "@awsapm"
          cli_tool: "claude_code"
          enable_cloudwatch_mcp: "true"

      # Step 2: Execute investigation with Claude Code
      - name: Run Claude Investigation
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt_file: ${{ steps.prepare.outputs.prompt_file }}
          use_bedrock: "true"
          claude_args: |
            --mcp-config-file ${{ steps.prepare.outputs.mcp_config_file }}
            --allowed-tools ${{ steps.prepare.outputs.allowed_tools }}
        env:
          # Specify the Bedrock model to use
          ANTHROPIC_MODEL: "us.anthropic.claude-sonnet-4-5-20250929-v1:0"
